<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1a2a6c">
    <meta name="description" content="Sistema de Controle Financeiro com Firebase e PWA">
    <link rel="icon" type="image/x-icon" href="/2224480_card_credit card_debit card_master card_icon.png">
    <title>Controle Financeiro Online</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <link rel="manifest" href="app.webmanifest">
    <link rel="apple-touch-icon" href="icon-192x192.png">

    <style>
        /* Estilos anteriores com melhorias para PWA */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #1a2a6c;
            --secondary: #b21f1f;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --dark: #343a40;
            --light: #f8f9fa;
            --pago: #d4edda;
            --pendente: #fff3cd;
            --chart-1: #4e73df;
            --chart-2: #1cc88a;
            --chart-3: #36b9cc;
            --chart-4: #f6c23e;
            --chart-5: #e74a3b;
            --chart-6: #ff0080;
            --chart-7: #ffb4dd;
        }

        body {
            background: linear-gradient(135deg, var(--primary), var(--secondary), var(--primary));
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        @keyframes gradientBG {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 20px 0;
            color: white;
            margin-bottom: 30px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        header h1 i {
            font-size: 3rem;
        }

        header p {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.92);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2 i {
            font-size: 1.8rem;
        }

        .value {
            font-size: 2.2rem;
            font-weight: bold;
            text-align: center;
            margin-top: auto;
        }

        .positive {
            color: var(--success);
        }

        .negative {
            color: var(--danger);
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 12px 12px 0 0;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 18px 20px;
            text-align: center;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            color: #495057;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            flex: 1;
            min-width: 140px;
        }

        .tab-button:hover {
            background: #e9ecef;
        }

        .tab-button.active {
            background: white;
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }

        .tab-content {
            background: white;
            border-radius: 0 0 12px 12px;
            padding: 30px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        .table-container {
            overflow-x: auto;
            margin: 20px 0;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background-color: var(--primary);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        tbody tr:hover {
            background-color: #f8f9fa;
        }

        tfoot {
            font-weight: bold;
            background-color: #f1f3f5;
        }

        tfoot td {
            font-size: 1.1rem;
        }

        .pago {
            background-color: var(--pago);
            color: #155724;
        }

        .pendente {
            background-color: var(--pendente);
            color: #856404;
        }

        input,
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 42, 108, 0.1);
        }

        .actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-align: center;
            white-space: nowrap;
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #15225a;
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: var(--warning);
            color: var(--dark);
        }

        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .btn i {
            font-size: 1.1rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .form-row>div {
            flex: 1;
            min-width: 200px;
        }

        .footer-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn-large {
            padding: 15px 30px;
            font-size: 1.1rem;
            min-width: 250px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 100%;
            max-width: 600px;
            padding: 30px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.8rem;
            cursor: pointer;
            color: #6c757d;
            background: none;
            border: none;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close:hover {
            background: #f1f1f1;
        }

        .login-container {
            background: white;
            border-radius: 15px;
            max-width: 500px;
            margin: 50px auto;
            padding: 40px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
        }

        .login-form .form-group {
            margin-bottom: 25px;
        }

        .login-form h2 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary);
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo i {
            font-size: 4rem;
            color: var(--primary);
            background: rgba(26, 42, 108, 0.1);
            padding: 20px;
            border-radius: 50%;
        }

        /* Status de sincronização */
        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 100;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .hidden {
            display: none;
        }

        /* Gráficos */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .chart-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .chart-card h3 {
            margin-bottom: 15px;
            color: var(--primary);
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* Painel Administrativo */
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .admin-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .admin-card h3 {
            margin-bottom: 15px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            header h1 {
                font-size: 2.2rem;
            }

            header h1 i {
                font-size: 2.5rem;
            }

            body {
                padding: 10px;
            }

            .card {
                padding: 15px;
            }

            .tab-button {
                min-width: 100px;
                padding: 15px 10px;
                font-size: 1rem;
            }

            .tab-content {
                padding: 20px 15px;
            }

            th,
            td {
                padding: 12px 10px;
            }

            .btn-large {
                min-width: 100%;
            }

            .modal-content {
                padding: 20px;
            }

            .charts-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }

        @media (max-width: 480px) {
            header h1 {
                font-size: 1.8rem;
            }

            header h1 i {
                font-size: 2rem;
            }

            body {
                padding: 5px;
            }

            .card {
                padding: 10px;
            }

            .value {
                font-size: 1.8rem;
            }

            .tab-button {
                min-width: 100%;
                border-radius: 0;
            }

            .actions {
                flex-direction: column;
                gap: 5px;
            }

            .table-container td.actions {
                min-width: 80px;
            }

            .btn-sm {
                padding: 6px 8px;
                font-size: 0.8rem;
                width: 100%;
            }

            th,
            td {
                padding: 8px;
                font-size: 0.85rem;
            }

            .form-row {
                flex-direction: column;
                gap: 10px;
            }

            .form-row>div {
                min-width: unset;
            }

            .footer-buttons {
                gap: 10px;
                flex-direction: column;
            }
        }

        /* Ajustes para login */
        #login-container {
            display: block;
        }

        #main-container {
            display: none;
        }

        /* Notificações */
        .notification-icon {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 1001;
            font-size: 1.5rem;
            color: var(--primary);
        }

        .notification-panel {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 350px;
            max-height: 400px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
            flex-direction: column;
        }

        .notification-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-header h5 {
            margin: 0;
        }

        .notification-list {
            overflow-y: auto;
            padding: 10px;
        }

        .notification-item {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .notification-item.warning {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .notification-item.danger {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
        }

        .notification-item.info {
            background-color: #d1ecf1;
            border-left: 4px solid #0dcaf0;
        }

        .notification-content {
            flex-grow: 1;
            margin-right: 10px;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: red;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <!-- Tela de Login -->
    <div id="login-container" class="login-container">
        <div class="logo">
            <i class="fas fa-wallet"></i>
        </div>
        <div class="login-form">
            <h2>Controle Financeiro</h2>
            <div class="form-group">
                <label for="login-email">Email</label>
                <input type="email" id="login-email" placeholder="seu@email.com">
            </div>
            <div class="form-group">
                <label for="login-password">Senha</label>
                <input type="password" id="login-password" placeholder="******">
            </div>
            <button class="btn btn-primary" onclick="login()">Entrar</button>
            <p style="text-align: center; margin-top: 20px;">
                <a href="#" onclick="showRegister()">Criar nova conta</a>
            </p>
        </div>
    </div>

    <!-- Conteúdo principal após login -->
    <div id="main-container" class="container">
        <div class="notification-icon" onclick="toggleNotifications()">
            <i class="fas fa-bell"></i>
            <span id="notification-badge" class="notification-badge"></span>
        </div>

        <div id="notification-panel" class="notification-panel">
            <div class="notification-header">
                <h5>Notificações</h5>
                <button class="btn btn-sm btn-link" onclick="markAllAsRead()">Marcar todas como lidas</button>
            </div>
            <div id="floating-notification-list" class="notification-list"></div>
        </div>

        <header>
            <h1><i class="fas fa-wallet"></i> Controle Financeiro Online</h1>
            <p>Gerencie suas finanças de qualquer dispositivo e compartilhe com quem quiser</p>
            <button class="btn btn-danger" onclick="logout()" style="margin-top: 10px;"><i
                    class="fas fa-sign-out-alt"></i> Sair</button>
        </header>

        <div class="dashboard">
            <div class="card">
                <h2><i class="fas fa-arrow-down"></i> Total de Entradas</h2>
                <div class="value positive" id="dashboard-entradas">R$ 0,00</div>
            </div>
            <div class="card">
                <h2><i class="fas fa-arrow-up"></i> Total de Saídas</h2>
                <div class="value" id="dashboard-saidas">R$ 0,00</div>
            </div>
            <div class="card">
                <h2><i class="fas fa-scale-balanced"></i> Saldo Final</h2>
                <div class="value" id="dashboard-saldo">R$ 0,00</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="openTab('entradas')">Entradas</button>
            <button class="tab-button" onclick="openTab('saidas')">Saídas</button>
            <button class="tab-button" onclick="openTab('resumo')">Resumo</button>
            <button class="tab-button" onclick="openTab('graficos')"><i class="fas fa-chart-bar"></i> Gráficos</button>
            <button class="tab-button" onclick="openTab('admin')" id="admin-tab"><i class="fas fa-user-shield"></i>
                Admin</button>
            <button class="tab-button" onclick="openTab('config')"><i class="fas fa-cog"></i> Configurações</button>
        </div>

        <div id="entradas" class="tab-content">
            <h2><i class="fas fa-arrow-down"></i> Entradas</h2>
            <div class="table-container">
                <table id="tblEntradas">
                    <thead>
                        <tr>
                            <th>Descrição</th>
                            <th>Valor (R$)</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dados serão inseridos via JS -->
                    </tbody>
                    <tfoot>
                        <tr>
                            <td>Total de Entradas</td>
                            <td id="totalEntradas">R$ 0,00</td>
                            <td><button class="btn btn-success" onclick="addEntrada()"><i class="fas fa-plus"></i>
                                    Adicionar</button></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div id="saidas" class="tab-content" style="display:none">
            <h2><i class="fas fa-arrow-up"></i> Saídas</h2>
            <div class="table-container">
                <table id="tblSaidas">
                    <thead>
                        <tr>
                            <th>Categoria</th>
                            <th>Descrição</th>
                            <th>Valor (R$)</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dados serão inseridos via JS -->
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="2">Total de Saídas</td>
                            <td id="totalSaidas">R$ 0,00</td>
                            <td colspan="2"><button class="btn btn-success" onclick="addSaida()"><i
                                        class="fas fa-plus"></i> Adicionar</button></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div id="resumo" class="tab-content" style="display:none">
            <h2><i class="fas fa-file-invoice-dollar"></i> Resumo Financeiro</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Valor (R$)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Total de Entradas</td>
                            <td id="resumoEntradas">R$ 0,00</td>
                        </tr>
                        <tr>
                            <td>Total de Saídas</td>
                            <td id="resumoSaidas">R$ 0,00</td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td><strong>Saldo Final</strong></td>
                            <td id="saldoFinal">R$ 0,00</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div id="graficos" class="tab-content" style="display:none">
            <h2><i class="fas fa-chart-bar"></i> Gráficos e Relatórios</h2>
            <div class="charts-container">
                <div class="chart-card">
                    <h3>Distribuição de Saídas por Categoria</h3>
                    <div class="chart-container">
                        <canvas id="categoriaChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Evolução Mensal</h3>
                    <div class="chart-container">
                        <canvas id="evolucaoChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Status de Pagamentos</h3>
                    <div class="chart-container">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Comparativo Entradas x Saídas</h3>
                    <div class="chart-container">
                        <canvas id="comparativoChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div id="admin" class="tab-content" style="display:none">
            <h2><i class="fas fa-user-shield"></i> Painel Administrativo</h2>

            <div class="admin-grid">
                <div class="admin-card">
                    <h3><i class="fas fa-users"></i> Usuários</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Último Login</th>
                                </tr>
                            </thead>
                            <tbody id="admin-users">
                                <!-- Dados de usuários -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="admin-card">
                    <h3><i class="fas fa-bell"></i> Notificações</h3>
                    <div class="notification-list" id="notification-list">
                        <!-- Notificações -->
                    </div>
                </div>

                <div class="admin-card">
                    <h3><i class="fas fa-envelope"></i> Enviar Notificação</h3>
                    <div class="form-group">
                        <label for="notification-email">Email do Destinatário</label>
                        <input type="email" id="notification-email" placeholder="destinatario@email.com">
                    </div>
                    <div class="form-group">
                        <label for="notification-subject">Assunto</label>
                        <input type="text" id="notification-subject" placeholder="Assunto da mensagem">
                    </div>
                    <div class="form-group">
                        <label for="notification-message">Mensagem</label>
                        <textarea id="notification-message" rows="3" placeholder="Digite sua mensagem..."></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="sendNotification()"><i class="fas fa-paper-plane"></i>
                        Enviar</button>
                </div>
            </div>
        </div>

        <div id="config" class="tab-content" style="display:none">
            <h2><i class="fas fa-cog"></i> Configurações</h2>

            <div class="card">
                <h3><i class="fas fa-globe"></i> Publicar Online</h3>
                <p>Compartilhe seu controle financeiro com outros usuários:</p>
                <div class="form-group">
                    <label for="shareLink">Link de Compartilhamento</label>
                    <div class="form-row">
                        <input type="text" id="shareLink" readonly>
                        <button class="btn btn-primary" onclick="copyShareLink()"><i class="fas fa-copy"></i> Copiar
                            Link</button>
                    </div>
                </div>
                <button class="btn btn-success" onclick="generateShareLink()"><i class="fas fa-share-alt"></i> Gerar
                    Link Público</button>
            </div>

            <div class="card">
                <h3><i class="fas fa-download"></i> Backup de Dados</h3>
                <p>Faça backup dos seus dados financeiros:</p>
                <div class="footer-buttons">
                    <button class="btn btn-primary" onclick="exportData()"><i class="fas fa-file-export"></i> Exportar
                        Dados</button>
                    <button class="btn btn-warning" onclick="document.getElementById('importFile').click()"><i
                            class="fas fa-file-import"></i> Importar Dados</button>
                    <input type="file" id="importFile" accept=".json" style="display: none"
                        onchange="importData(event)">
                </div>
            </div>

            <div class="card">
                <h3><i class="fas fa-sync-alt"></i> Sincronização</h3>
                <p>Mantenha seus dados atualizados em todos os dispositivos:</p>
                <div class="footer-buttons">
                    <button class="btn btn-primary" onclick="saveToCloud()"><i class="fas fa-cloud-upload-alt"></i>
                        Salvar na Nuvem</button>
                    <button class="btn btn-success" onclick="loadFromCloud()"><i class="fas fa-cloud-download-alt"></i>
                        Carregar da Nuvem</button>
                </div>
            </div>
        </div>

        <div class="footer-buttons">
            <button class="btn btn-primary btn-large" onclick="gerarPDF()"><i class="fas fa-file-pdf"></i> Exportar para
                PDF</button>
            <button class="btn btn-warning btn-large" onclick="resetData()"><i class="fas fa-sync-alt"></i> Reiniciar
                Dados</button>
        </div>
    </div>

    <!-- Modais -->
    <div id="entradaModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('entradaModal')">&times;</span>
            <h2><i class="fas fa-plus-circle"></i> Adicionar Nova Entrada</h2>
            <div class="form-group">
                <label for="entradaDescricao">Descrição</label>
                <input type="text" id="entradaDescricao" placeholder="Ex: Salário">
            </div>
            <div class="form-group">
                <label for="entradaValor">Valor (R$)</label>
                <input type="text" id="entradaValor" placeholder="Ex: 1500,00">
            </div>
            <button class="btn btn-primary" onclick="saveEntrada()"><i class="fas fa-save"></i> Salvar Entrada</button>
        </div>
    </div>

    <div id="saidaModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('saidaModal')">&times;</span>
            <h2><i class="fas fa-plus-circle"></i> Adicionar Nova Saída</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="saidaCategoria">Categoria</label>
                    <select id="saidaCategoria">
                        <option value="💳 Cartão de Crédito">💳 Cartão de Crédito</option>
                        <option value="🌐 Internet & Celular">🌐 Internet & Celular</option>
                        <option value="🧾 Contas Fixas">🧾 Contas Fixas</option>
                        <option value="💇 Cuidado Pessoal">💇 Cuidado Pessoal</option>
                        <option value="🔧 Manutenção">🔧 Manutenção</option>
                        <option value="🍔 Alimentação">🍔 Alimentação</option>
                        <option value="⚰️ Outros Gastos">⚰️ Outros Gastos</option>
                        <option value="💸 Outros Gastos">💸 Outros Gastos</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="saidaStatus">Status</label>
                    <select id="saidaStatus">
                        <option value="Pago">Pago</option>
                        <option value="Pendente">Pendente</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="saidaDescricao">Descrição</label>
                <input type="text" id="saidaDescricao" placeholder="Ex: Pagamento de conta">
            </div>
            <div class="form-group">
                <label for="saidaValor">Valor (R$)</label>
                <input type="text" id="saidaValor" placeholder="Ex: 250,00">
            </div>
            <div class="form-group">
                <label for="saidaVencimento">Data de Vencimento</label>
                <input type="date" id="saidaVencimento">
            </div>
            <button class="btn btn-primary" onclick="saveSaida()"><i class="fas fa-save"></i> Salvar Saída</button>
        </div>
    </div>

    <div id="registerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('registerModal')">&times;</span>
            <h2><i class="fas fa-user-plus"></i> Criar Nova Conta</h2>
            <div class="form-group">
                <label for="register-email">Email</label>
                <input type="email" id="register-email" placeholder="seu@email.com">
            </div>
            <div class="form-group">
                <label for="register-password">Senha</label>
                <input type="password" id="register-password" placeholder="******">
            </div>
            <div class="form-group">
                <label for="register-password-confirm">Confirmar Senha</label>
                <input type="password" id="register-password-confirm" placeholder="******">
            </div>
            <button class="btn btn-primary" onclick="register()">Registrar</button>
            <p style="text-align: center; margin-top: 20px;">
                <a href="#" onclick="backToLogin()">Voltar para o login</a>
            </p>
        </div>
    </div>

    <!-- Status de sincronização -->
    <div id="syncStatus" class="sync-status hidden">
        <i class="fas fa-sync-alt fa-spin"></i>
        <span id="syncMessage">Sincronizando dados...</span>
    </div>

    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCLS-1GwCoyQVRCAHG_b2fwVOcIRjAEu-0",
            authDomain: "controle-financeiro-onli-a2584.firebaseapp.com",
            projectId: "controle-financeiro-onli-a2584",
            storageBucket: "controle-financeiro-onli-a2584.firebasestorage.app",
            messagingSenderId: "929745653564",
            appId: "1:929745653564:web:7e25c5e6d071055ab15839",
            measurementId: "G-PK9Z9K4MZT"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Variáveis globais
        let entradas = [];
        let saidas = [];
        let currentUser = null;
        let isAdmin = false;

        // Observador de estado de autenticação
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('login-container').style.display = 'none';
                document.getElementById('main-container').style.display = 'block';

                // Carregar dados do usuário
                loadUserData();

                // Atualizar último login
                db.collection('users').doc(user.uid).set({
                    lastLogin: new Date()
                }, { merge: true });

                // Mostrar notificações
                showNotifications();

            } else {
                document.getElementById('login-container').style.display = 'block';
                document.getElementById('main-container').style.display = 'none';
            }
        });

        // Função para gerar notificações de vencimento
        function generateDueNotifications() {
            const hoje = new Date();
            const notifications = [];

            saidas.forEach((saida, index) => {
                if (saida.vencimento && saida.status !== 'Pago') {
                    const vencimento = new Date(saida.vencimento);
                    // Ajustar para considerar a data sem hora
                    vencimento.setHours(0, 0, 0, 0);
                    const diffDias = Math.ceil((vencimento - hoje) / (1000 * 60 * 60 * 24));

                    if (diffDias <= 3 && diffDias >= 0) {
                        notifications.push({
                            title: 'Conta próxima do vencimento',
                            message: `A conta "${saida.descricao}" vence em ${diffDias} dia(s)`,
                            type: 'warning',
                            timestamp: new Date().getTime(),
                            billId: index
                        });
                    }
                    else if (diffDias < 0) {
                        notifications.push({
                            title: 'Conta vencida!',
                            message: `A conta "${saida.descricao}" está ${Math.abs(diffDias)} dia(s) atrasada`,
                            type: 'danger',
                            timestamp: new Date().getTime(),
                            billId: index
                        });
                    }
                }
            });

            return notifications;
        }

        // Função para exibir notificações
        function showNotifications() {
            const adminList = document.getElementById('notification-list');
            const floatingList = document.getElementById('floating-notification-list');
            adminList.innerHTML = '';
            floatingList.innerHTML = '';

            // Notificações de vencimento (geradas em tempo real)
            const dueNotifications = generateDueNotifications();

            // Notificações persistentes (salvas no Firebase)
            db.collection('notifications')
                .where('userId', '==', currentUser.uid)
                .where('read', '==', false)
                .orderBy('timestamp', 'desc')
                .limit(10)
                .get()
                .then(snapshot => {
                    // Combinar ambas as notificações
                    const allNotifications = [...dueNotifications, ...snapshot.docs.map(doc => {
                        return { id: doc.id, ...doc.data() };
                    })];

                    // Ordenar por timestamp (mais recente primeiro)
                    allNotifications.sort((a, b) => b.timestamp - a.timestamp);

                    // Renderizar
                    allNotifications.forEach(notification => {
                        const item = document.createElement('div');
                        item.className = `notification-item ${notification.type || 'info'}`;

                        let content = `
                            <div class="notification-content">
                                <strong>${notification.title}</strong>
                                <p>${notification.message}</p>
                                <small>${new Date(notification.timestamp).toLocaleString()}</small>
                            </div>
                        `;

                        if (notification.billId !== undefined) {
                            content += `
                                <button class="btn btn-sm btn-primary" onclick="editarSaida(${notification.billId})">
                                    <i class="fas fa-edit"></i> Ver Conta
                                </button>
                            `;
                        }

                        if (notification.id) {
                            content += `
                                <button class="btn btn-sm btn-light" onclick="markNotificationAsRead('${notification.id}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                        }

                        item.innerHTML = content;

                        // Adicionar à lista administrativa (admin-card)
                        adminList.appendChild(item.cloneNode(true));
                        // Adicionar à lista flutuante
                        floatingList.appendChild(item);
                    });

                    // Atualizar badge
                    const notificationBadge = document.getElementById('notification-badge');
                    notificationBadge.textContent = allNotifications.length > 0 ? allNotifications.length : '';
                    notificationBadge.style.display = allNotifications.length > 0 ? 'block' : 'none';
                })
                .catch(error => {
                    console.error("Erro ao carregar notificações: ", error);
                });
        }

        function toggleNotifications() {
            const panel = document.getElementById('notification-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            if (panel.style.display === 'block') {
                showNotifications();
            }
        }

        function markNotificationAsRead(notificationId) {
            db.collection('notifications').doc(notificationId).update({
                read: true
            }).then(() => {
                showNotifications();
            });
        }

        function markAllAsRead() {
            db.collection('notifications')
                .where('userId', '==', currentUser.uid)
                .where('read', '==', false)
                .get()
                .then(snapshot => {
                    const batch = db.batch();
                    snapshot.forEach(doc => {
                        batch.update(doc.ref, { read: true });
                    });
                    return batch.commit();
                })
                .then(() => {
                    showNotifications();
                });
        }

        // Função para salvar dados no Firebase
    // Função de salvamento atualizada para preservar dados históricos
        async function saveData() {
            if (!currentUser) return;

            try {
                const userDocRef = db.collection('users').doc(currentUser.uid);
                const doc = await userDocRef.get();

                if (doc.exists) {
                    const existingData = doc.data();
                    // Combina dados existentes com novos dados
                    await userDocRef.update({
                        entradas: [...(existingData.entradas || []), ...entradas],
                        saidas: [...(existingData.saidas || []), ...saidas],
                        lastUpdate: new Date()
                    });
                } else {
                    // Cria novo documento se não existir
                    await userDocRef.set({
                        entradas: entradas,
                        saidas: saidas,
                        created: new Date(),
                        lastUpdate: new Date()
                    });
                }
                console.log("Dados salvos com sucesso!");
                showSyncStatus('Dados sincronizados!', 'success');
            } catch (error) {
                console.error("Erro ao salvar:", error);
                showSyncStatus('Erro ao sincronizar dados!', 'error');
            }
        }

        // Função para carregar dados do Firebase (atualizada)
        // Função para carregar dados do Firebase (corrigida)
        
            async function loadUserData() {
                if (!currentUser) return;

                try {
                    const userRef = db.collection('users').doc(currentUser.uid);
                    const doc = await userRef.get();

                    if (doc.exists) {
                        const data = doc.data();
                        // CORREÇÃO: Substituir arrays locais em vez de combinar
                        entradas = data.entradas || [];
                        saidas = data.saidas || [];

                        // Atualizar interface
                        renderizarTabelas();
                        calcularTotais();

                        showSyncStatus('Dados carregados!', 'success');
                    } else {
                        // Primeiro acesso - criar documento
                        await userRef.set({
                            entradas: entradas,
                            saidas: saidas,
                            created: new Date(),
                            lastUpdate: new Date()
                        });
                    }

                    // Atualizar notificações
                    showNotifications();

                } catch (error) {
                    console.error('Erro ao carregar dados:', error);
                    showSyncStatus('Erro ao carregar dados!', 'error');
                }
            }


        // Função de login
        function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            auth.signInWithEmailAndPassword(email, password)
                .then(() => showSyncStatus('Login realizado!', 'success'))
                .catch(error => {
                    console.error('Erro de login:', error);
                    showSyncStatus(`Erro: ${error.message}`, 'error');
                });
        }

        // Função de logout
        function logout() {
            auth.signOut()
                .then(() => {
                    showSyncStatus('Logout realizado com sucesso!', 'success');
                })
                .catch((error) => {
                    showSyncStatus(`Erro: ${error.message}`, 'error');
                });
        }

        function showRegister() {
            openModal('registerModal');
        }

        function backToLogin() {
            const registerModal = document.getElementById('registerModal');
            registerModal.style.display = 'none';
            document.getElementById('login-container').style.display = 'block';
        }

        function closeModal(modalId) {
            let modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = "none";
            } else {
                console.error(`Erro: O modal com ID '${modalId}' não foi encontrado.`);
            }
        }

        function register() {
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-password-confirm').value;

            if (password !== confirmPassword) {
                showSyncStatus('As senhas não coincidem!', 'error');
                return;
            }

            auth.createUserWithEmailAndPassword(email, password)
                .then(() => {
                    closeModal('registerModal');
                    showSyncStatus('Conta criada com sucesso!', 'success');
                })
                .catch(error => showSyncStatus(`Erro: ${error.message}`, 'error'));
        }

        // Funções para adicionar/editar entradas
        function addEntrada() {
            document.getElementById('entradaDescricao').value = '';
            document.getElementById('entradaValor').value = '';
            openModal('entradaModal');
        }

            function saveEntrada() {
                const descricao = document.getElementById('entradaDescricao').value;
                const valor = parseFloat(document.getElementById('entradaValor').value.replace(',', '.'));

                if (!descricao || isNaN(valor)) {
                    showSyncStatus('Por favor, preencha todos os campos corretamente!', 'error');
                    return;
                }

                // ADICIONA nova entrada sem remover as existentes
                entradas.push({ descricao, valor });

                closeModal('entradaModal');
                showSyncStatus('Entrada adicionada!', 'success');
                renderizarTabelas();
                calcularTotais();
                saveData();
            }

        function editarEntrada(index) {
            document.getElementById('entradaDescricao').value = entradas[index].descricao;
            document.getElementById('entradaValor').value = entradas[index].valor;
            openModal('entradaModal');

            // Substitui a entrada ao salvar
            const saveBtn = document.querySelector('#entradaModal .btn');
            saveBtn.onclick = function () {
                const descricao = document.getElementById('entradaDescricao').value;
                const valor = parseFloat(document.getElementById('entradaValor').value.replace(',', '.'));

                if (!descricao || isNaN(valor)) {
                    alert('Por favor, preencha todos os campos corretamente!');
                    return;
                }

                entradas[index] = { descricao, valor };
                closeModal('entradaModal');
                renderizarTabelas();
                calcularTotais();
                saveData();
            };
        }

        function removerEntrada(index) {
            if (confirm('Tem certeza que deseja remover esta entrada?')) {
                entradas.splice(index, 1);
                renderEntradas();
                calcularTotais();
                saveData();
            }
        }

    // Funções para adicionar/editar entradas
    function addEntrada() {
        document.getElementById('entradaDescricao').value = '';
        document.getElementById('entradaValor').value = '';
        openModal('entradaModal');

        // Focar automaticamente no primeiro campo
        setTimeout(() => {
            document.getElementById('entradaDescricao').focus();
        }, 100);
    }

    // Função de salvamento atualizada
   // Função de salvamento corrigida
    async function saveData() {
        if (!currentUser) return;

        try {
            const userDocRef = db.collection('users').doc(currentUser.uid);

            // SEMPRE substituímos os dados no Firebase pelos locais atuais
            await userDocRef.set({
                entradas: entradas,
                saidas: saidas,
                lastUpdate: new Date()
            }, { merge: true }); // merge: true preserva outros campos (como created)

            console.log("Dados salvos com sucesso!");
            showSyncStatus('Dados sincronizados!', 'success');
        } catch (error) {
            console.error("Erro ao salvar:", error);
            showSyncStatus('Erro ao sincronizar dados!', 'error');
        }
    }



    function editarEntrada(index) {
        document.getElementById('entradaDescricao').value = entradas[index].descricao;
        document.getElementById('entradaValor').value = entradas[index].valor;
        openModal('entradaModal');

        // Substitui a entrada ao salvar
        const saveBtn = document.querySelector('#entradaModal .btn');
        saveBtn.onclick = function () {
            const descricao = document.getElementById('entradaDescricao').value;
            const valor = parseFloat(document.getElementById('entradaValor').value.replace(',', '.'));

            if (!descricao || isNaN(valor)) {
                showSyncStatus('Por favor, preencha todos os campos corretamente!', 'error');
                return;
            }

            entradas[index] = { descricao, valor };
            closeModal('entradaModal');
            showSyncStatus('Entrada atualizada!', 'success');
            renderizarTabelas();
            calcularTotais();
            saveData();
        };
    }

    function removerEntrada(index) {
        if (confirm('Tem certeza que deseja remover esta entrada?')) {
            entradas.splice(index, 1);
            renderEntradas();
            calcularTotais();
            saveData();
            showSyncStatus('Entrada removida!', 'success');
        }
    }

    // Funções para adicionar/editar saídas
    function addSaida() {
        document.getElementById('saidaCategoria').value = '💳 Cartão de Crédito';
        document.getElementById('saidaDescricao').value = '';
        document.getElementById('saidaValor').value = '';
        document.getElementById('saidaStatus').value = 'Pendente';
        document.getElementById('saidaVencimento').value = '';
        openModal('saidaModal');

        // Focar automaticamente no primeiro campo
        setTimeout(() => {
            document.getElementById('saidaDescricao').focus();
        }, 100);
    }

    function saveSaida() {
            const categoria = document.getElementById('saidaCategoria').value;
            const descricao = document.getElementById('saidaDescricao').value;
            const valor = parseFloat(document.getElementById('saidaValor').value.replace(',', '.'));
            const status = document.getElementById('saidaStatus').value;
            const vencimento = document.getElementById('saidaVencimento').value;

            if (!descricao || isNaN(valor)) {
                showSyncStatus('Por favor, preencha todos os campos corretamente!', 'error');
                return;
            }

            // ADICIONA nova saída sem remover as existentes
            saidas.push({ categoria, descricao, valor, status, vencimento });

            // Feedback e limpeza
            showSyncStatus('Saída adicionada!', 'success');

            closeModal('saidaModal');
            renderizarTabelas();
            calcularTotais();
            saveData();
        

        // Verificar se é necessário enviar notificação
        if (vencimento) {
            const hoje = new Date();
            const dataVencimento = new Date(vencimento);
            const diffDias = Math.ceil((dataVencimento - hoje) / (1000 * 60 * 60 * 24));

            if (diffDias <= 3 && diffDias >= 0) {
                const notification = {
                    userId: currentUser.uid,
                    title: 'Conta próxima do vencimento',
                    message: `A conta "${descricao}" vence em ${diffDias} dias`,
                    type: 'warning',
                    timestamp: new Date().getTime(),
                    billId: saidas.length - 1,
                    read: false
                };

                db.collection('notifications').add(notification);
            }
        }
    }

    function editarSaida(index) {
        document.getElementById('saidaCategoria').value = saidas[index].categoria;
        document.getElementById('saidaDescricao').value = saidas[index].descricao;
        document.getElementById('saidaValor').value = saidas[index].valor;
        document.getElementById('saidaStatus').value = saidas[index].status;
        document.getElementById('saidaVencimento').value = saidas[index].vencimento || '';
        openModal('saidaModal');

        // Substitui a saída ao salvar
        const saveBtn = document.querySelector('#saidaModal .btn');
        saveBtn.onclick = function () {
            const categoria = document.getElementById('saidaCategoria').value;
            const descricao = document.getElementById('saidaDescricao').value;
            const valor = parseFloat(document.getElementById('saidaValor').value.replace(',', '.'));
            const status = document.getElementById('saidaStatus').value;
            const vencimento = document.getElementById('saidaVencimento').value;

            if (!descricao || isNaN(valor)) {
                showSyncStatus('Por favor, preencha todos os campos corretamente!', 'error');
                return;
            }

            // Se a conta estava pendente e agora foi paga, remover notificações
            if (saidas[index].status !== 'Pago' && status === 'Pago') {
                clearBillNotifications(index);
            }

            saidas[index] = { categoria, descricao, valor, status, vencimento };
            closeModal('saidaModal');
            showSyncStatus('Saída atualizada!', 'success');
            renderizarTabelas();
            calcularTotais();
            saveData();
        };
    }

        function clearBillNotifications(billId) {
            db.collection('notifications')
                .where('userId', '==', currentUser.uid)
                .where('billId', '==', billId)
                .get()
                .then(snapshot => {
                    const batch = db.batch();
                    snapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    return batch.commit();
                })
                .then(() => {
                    showNotifications();
                });
        }

        function removerSaida(index) {
            if (confirm('Tem certeza que deseja remover esta saída?')) {
                // Remover notificações relacionadas
                clearBillNotifications(index);

                saidas.splice(index, 1);
                renderSaidas();
                calcularTotais();
                saveData();
            }
        }

        // Funções principais
        function renderizarTabelas() {
            renderEntradas();
            renderSaidas();
        }

        function renderEntradas() {
            const tbody = document.querySelector('#tblEntradas tbody');
            tbody.innerHTML = '';

            entradas.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.descricao}</td>
                    <td>${formatarMoeda(item.valor)}</td>
                    <td class="actions">
                        <button class="btn btn-primary btn-sm" onclick="editarEntrada(${index})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger btn-sm" onclick="removerEntrada(${index})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderSaidas() {
            const tbody = document.querySelector('#tblSaidas tbody');
            tbody.innerHTML = '';

            saidas.forEach((item, index) => {
                const tr = document.createElement('tr');

                // Obter cor da categoria
                const bgColor = getCategoriaColor(item.categoria);

                // Aplicar estilo de cor
                tr.style.backgroundColor = bgColor + '22';
                tr.style.borderLeft = `4px solid ${bgColor}`;

                tr.innerHTML = `
                    <td>${item.categoria}</td>
                    <td>${item.descricao}</td>
                    <td>${formatarMoeda(item.valor)}</td>
                    <td class="${item.status === 'Pago' ? 'pago' : 'pendente'}">${item.status}</td>
                    <td class="actions">
                        <button class="btn btn-primary btn-sm" onclick="editarSaida(${index})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="removerSaida(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Função para obter cores em hexadecimal
        function getCategoriaColor(categoria) {
            const colorMap = {
                "💳 Cartão de Crédito": "#4e73df",
                "🌐 Internet & Celular": "#1cc88a",
                "🧾 Contas Fixas": "#36b9cc",
                "💇 Cuidado Pessoal": "#f6c23e",
                "🔧 Manutenção": "#e74a3b",
                "🍔 Alimentação": "#858796",
                "⚰️ Outros Gastos": "#ff0080",
                "💸 Outros Gastos": "#ffb4dd"
            };
            return colorMap[categoria] || "#e5ff00";
        }

        function calcularTotais() {
            // Entradas
            const totalEntradas = entradas.reduce((sum, item) => sum + item.valor, 0);
            document.getElementById('totalEntradas').textContent = formatarMoeda(totalEntradas);
            document.getElementById('resumoEntradas').textContent = formatarMoeda(totalEntradas);
            document.getElementById('dashboard-entradas').textContent = formatarMoeda(totalEntradas);

            // Saídas
            const totalSaidas = saidas.reduce((sum, item) => sum + item.valor, 0);
            document.getElementById('totalSaidas').textContent = formatarMoeda(totalSaidas);
            document.getElementById('resumoSaidas').textContent = formatarMoeda(totalSaidas);
            document.getElementById('dashboard-saidas').textContent = formatarMoeda(totalSaidas);

            // Saldo
            const saldo = totalEntradas - totalSaidas;
            document.getElementById('saldoFinal').textContent = formatarMoeda(saldo);
            document.getElementById('dashboard-saldo').textContent = formatarMoeda(saldo);

            // Estilização do saldo
            const saldoElem = document.getElementById('dashboard-saldo');
            saldoElem.className = 'value ' + (saldo < 0 ? 'negative' : 'positive');

            // Salvar dados no Firebase
            saveData();

            // Atualizar gráficos
            if (document.getElementById('graficos').style.display !== 'none') {
                renderizarGraficos();
            }

            // Atualizar notificações
            showNotifications();
        }

        // Funções de gráficos
        function renderizarGraficos() {
            // Gráfico de categorias
            const categorias = {};
            saidas.forEach(saida => {
                if (categorias[saida.categoria]) {
                    categorias[saida.categoria] += saida.valor;
                } else {
                    categorias[saida.categoria] = saida.valor;
                }
            });

            // Crie um array de cores dinamicamente usando getCategoriaColor
            const categoryColors = Object.keys(categorias).map(categoria => getCategoriaColor(categoria));

            const categoriaCtx = document.getElementById('categoriaChart').getContext('2d');

            // Destrua o gráfico existente antes de criar um novo, se houver
            if (window.categoriaChartInstance) {
                window.categoriaChartInstance.destroy();
            }

            window.categoriaChartInstance = new Chart(categoriaCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categorias),
                    datasets: [{
                        data: Object.values(categorias),
                        backgroundColor: categoryColors
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });

            // Gráfico de status
            const statusCount = {
                'Pago': saidas.filter(s => s.status === 'Pago').length,
                'Pendente': saidas.filter(s => s.status === 'Pendente').length
            };

            const statusCtx = document.getElementById('statusChart').getContext('2d');
            if (window.statusChartInstance) {
                window.statusChartInstance.destroy();
            }
            window.statusChartInstance = new Chart(statusCtx, {
                type: 'pie',
                data: {
                    labels: ['Pago', 'Pendente'],
                    datasets: [{
                        data: [statusCount.Pago, statusCount.Pendente],
                        backgroundColor: ['var(--success)', 'var(--warning)']
                    }]
                },
                options: {
                    responsive: true
                }
            });

            // Gráfico comparativo
            const totalEntradas = entradas.reduce((sum, item) => sum + item.valor, 0);
            const totalSaidas = saidas.reduce((sum, item) => sum + item.valor, 0);

            const comparativoCtx = document.getElementById('comparativoChart').getContext('2d');
            if (window.comparativoChartInstance) {
                window.comparativoChartInstance.destroy();
            }
            window.comparativoChartInstance = new Chart(comparativoCtx, {
                type: 'bar',
                data: {
                    labels: ['Entradas', 'Saídas'],
                    datasets: [{
                        label: 'Valores',
                        data: [totalEntradas, totalSaidas],
                        backgroundColor: ['var(--success)', 'var(--danger)']
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Gráfico de evolução mensal
            const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            const entradasMensais = meses.map(() => Math.floor(Math.random() * 5000) + 2000);
            const saidasMensais = meses.map(() => Math.floor(Math.random() * 4500) + 1500);

            const evolucaoCtx = document.getElementById('evolucaoChart').getContext('2d');
            if (window.evolucaoChartInstance) {
                window.evolucaoChartInstance.destroy();
            }
            window.evolucaoChartInstance = new Chart(evolucaoCtx, {
                type: 'line',
                data: {
                    labels: meses,
                    datasets: [
                        {
                            label: 'Entradas',
                            data: entradasMensais,
                            borderColor: 'var(--success)',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'Saídas',
                            data: saidasMensais,
                            borderColor: 'var(--danger)',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            tension: 0.3,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function sendNotification() {
            const email = document.getElementById('notification-email').value;
            const subject = document.getElementById('notification-subject').value;
            const message = document.getElementById('notification-message').value;

            if (!email || !subject || !message) {
                showSyncStatus('Por favor, preencha todos os campos!', 'error');
                return;
            }

            // Simulação de envio de email
            showSyncStatus(`Notificação enviada para ${email}`, 'success');

            // Limpar campos
            document.getElementById('notification-email').value = '';
            document.getElementById('notification-subject').value = '';
            document.getElementById('notification-message').value = '';
        }

        // Funções administrativas
        function checkAdminStatus() {
            if (!currentUser) return;

            // Verificar se o usuário é admin
            isAdmin = true;
            document.getElementById('admin-tab').style.display = isAdmin ? 'block' : 'none';

            if (isAdmin) {
                loadAdminUsers();
                showNotifications();
            }
        }

        function loadAdminUsers() {
            db.collection('users').get().then(snapshot => {
                const usersTable = document.getElementById('admin-users');
                usersTable.innerHTML = '';

                snapshot.forEach(doc => {
                    const user = doc.data();
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${user.email}</td>
                        <td>${user.lastLogin ? new Date(user.lastLogin).toLocaleString() : 'N/A'}</td>
                    `;
                    usersTable.appendChild(tr);
                });
            });
        }

        // Funções auxiliares
        function formatarMoeda(valor) {
            return 'R$ ' + parseFloat(valor).toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(tabName).style.display = 'block';
            event.currentTarget.classList.add('active');

            if (tabName === 'graficos') {
                renderizarGraficos();
            } else if (tabName === 'admin' && isAdmin) {
                loadAdminUsers();
                showNotifications();
            }
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function resetData() {
            if (confirm('Tem certeza que deseja reiniciar todos os dados? Isso apagará todas as informações atuais.')) {
                entradas = [];
                saidas = [];
                renderizarTabelas();
                calcularTotais();
                saveData();
            }
        }

        function showSyncStatus(message, type = 'info') {
            const syncStatus = document.getElementById('syncStatus');
            const syncMessage = document.getElementById('syncMessage');

            syncMessage.textContent = message;
            syncStatus.className = 'sync-status';

            // Define a cor baseada no tipo
            if (type === 'success') {
                syncStatus.style.backgroundColor = 'var(--success)';
            } else if (type === 'error') {
                syncStatus.style.backgroundColor = 'var(--danger)';
            } else if (type === 'warning') {
                syncStatus.style.backgroundColor = 'var(--warning)';
                syncMessage.style.color = '#000';
            } else {
                syncStatus.style.backgroundColor = 'var(--primary)';
            }

            // Esconde após 3 segundos
            setTimeout(() => {
                syncStatus.className = 'sync-status hidden';
            }, 3000);
        }

        // Geração de PDF
        function gerarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Título
            doc.setFontSize(20);
            doc.text("Relatório Financeiro", 105, 20, null, null, 'center');
            doc.setFontSize(12);
            doc.text(`Gerado em: ${new Date().toLocaleDateString()}`, 105, 28, null, null, 'center');

            // Tabela de Entradas
            doc.autoTable({
                startY: 35,
                head: [['Descrição', 'Valor (R$)']],
                body: entradas.map(item => [item.descricao, formatarMoeda(item.valor)]),
                theme: 'grid',
                headStyles: { fillColor: [26, 42, 108] },
                margin: { top: 10 }
            });

            // Tabela de Saídas
            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 10,
                head: [['Categoria', 'Descrição', 'Valor (R$)', 'Status']],
                body: saidas.map(item => [item.categoria, item.descricao, formatarMoeda(item.valor), item.status]),
                theme: 'grid',
                headStyles: { fillColor: [26, 42, 108] },
                didDrawCell: function (data) {
                    if (data.section === 'body' && data.column.index === 3) {
                        if (data.cell.raw === 'Pago') {
                            doc.setTextColor(21, 87, 36);
                            doc.setFillColor(212, 237, 218);
                        } else {
                            doc.setTextColor(133, 100, 4);
                            doc.setFillColor(255, 243, 205);
                        }
                        doc.rect(data.cell.x, data.cell.y, data.cell.width, data.cell.height, 'F');
                        doc.text(data.cell.raw, data.cell.x + data.cell.width / 2, data.cell.y + data.cell.height / 2 + 2, { align: 'center' });
                        return false;
                    }
                }
            });

            // Resumo
            const totalEntradas = entradas.reduce((a, b) => a + b.valor, 0);
            const totalSaidas = saidas.reduce((a, b) => a + b.valor, 0);
            const saldo = totalEntradas - totalSaidas;

            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 10,
                body: [
                    ['Total de Entradas', formatarMoeda(totalEntradas)],
                    ['Total de Saídas', formatarMoeda(totalSaidas)],
                    ['Saldo Final', formatarMoeda(saldo)]
                ],
                theme: 'grid',
                headStyles: { fillColor: [26, 42, 108] },
                bodyStyles: { fontSize: 14 },
                styles: { fontStyle: 'bold' },
                didDrawCell: function (data) {
                    if (data.section === 'body' && data.row.index === 2) {
                        doc.setTextColor(saldo < 0 ? 231 : 46, saldo < 0 ? 76 : 204, saldo < 0 ? 60 : 113);
                    }
                }
            });

            doc.save(`relatorio-financeiro-${new Date().toISOString().slice(0, 10)}.pdf`);
        }

        // Funções de backup
        function exportData() {
            const data = {
                entradas: entradas,
                saidas: saidas
            };

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "backup-financeiro.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();

            showSyncStatus('Backup exportado com sucesso!', 'success');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    entradas = data.entradas || [];
                    saidas = data.saidas || [];
                    renderizarTabelas();
                    calcularTotais();
                    saveData();
                    showSyncStatus('Dados importados com sucesso!', 'success');
                } catch (error) {
                    showSyncStatus('Erro ao importar dados. Arquivo inválido!', 'error');
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
        }

        // Funções de compartilhamento
        function generateShareLink() {
            const shareLink = `${window.location.origin}${window.location.pathname}?share=true`;
            document.getElementById('shareLink').value = shareLink;
            showSyncStatus('Link gerado com sucesso!', 'success');
        }

        function copyShareLink() {
            const linkInput = document.getElementById('shareLink');
            linkInput.select();
            document.execCommand('copy');
            showSyncStatus('Link copiado para a área de transferência!', 'success');
        }

        // Funções de sincronização
        function saveToCloud() {
            showSyncStatus('Salvando dados na nuvem...', 'info');
            saveData();
            setTimeout(() => {
                showSyncStatus('Dados salvos na nuvem com sucesso!', 'success');
            }, 1500);
        }

        function loadFromCloud() {
            showSyncStatus('Carregando dados da nuvem...', 'info');
            loadUserData();
            setTimeout(() => {
                showSyncStatus('Dados carregados da nuvem com sucesso!', 'success');
            }, 1500);
        }

        // PWA: Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js')
                .then(() => console.log('Service Worker registrado!'))
                .catch(error => console.error('Erro ao registrar Service Worker:', error));
        }

        // PWA: Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // Mostrar botão de instalação
            const installBtn = document.createElement('button');
            installBtn.textContent = 'Instalar App';
            installBtn.className = 'btn btn-primary';
            installBtn.style.position = 'fixed';
            installBtn.style.bottom = '20px';
            installBtn.style.left = '20px';
            installBtn.style.zIndex = '1000';

            installBtn.addEventListener('click', () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(choiceResult => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('Usuário aceitou a instalação');
                    }
                    deferredPrompt = null;
                });
            });

            document.body.appendChild(installBtn);
        });
    </script>
</body>

</html>